---
title: "Group B Analysis - Calibration"
output: pdf_document
---

```{r message=FALSE}
library(jsonlite)
library(dplyr)
library(tidyr)
library(ggplot2)
library(patchwork)
library(lmerTest)
library(broom.mixed)
```



<!--Read JSON files and bind together into a tibble.-->

```{r}
data.files <- list.files('data', full.names = TRUE, pattern=".json")
data.tables <- lapply(data.files, function(file){
  data.table <- fromJSON(file)
  return(data.table)
})
all.data <- bind_rows(data.tables)
```

```{r}

all.data.calib = all.data %>% 
  filter(trial_type == "webgazer-validate") %>% 
  dplyr::select(subject_id, trial_index,  percent_in_roi, average_offset) %>% 
  tidyr::unnest(percent_in_roi)
  
summary.data.calib = all.data.calib %>% 
  group_by(subject_id, trial_index) %>% 
  summarize(mean_percent_in_roi = mean(percent_in_roi)) %>% 
  group_by(subject_id) %>% 
  mutate(calib_num = row_number())
```

```{r, eval = F}
ggplot(summary.data.calib)+
  geom_line(aes(x = calib_num, y = mean_percent_in_roi, color=subject_id))+
  theme_bw()+
  theme(legend.position = "none") 
```
```{r, eval=F}
summary.data.calib.wide = summary.data.calib %>% 
  select(-trial_index) %>% 
  pivot_wider(id_cols = subject_id, names_from=calib_num, values_from = mean_percent_in_roi )

# correlation between initial and halfway calibration
ggplot(summary.data.calib.wide %>% filter(is.na(`3`)), aes(x = `1`, y = `2`))+
  geom_point()+
  geom_smooth(method = 'lm')+
  theme_bw()+
  theme(legend.position = "none") 

# correlation between 2 successive calibration attempts
ggplot(summary.data.calib.wide %>% filter(!is.na(`3`)), aes(x = `1`, y = `2`))+
  geom_point()+
  geom_smooth(method = 'lm')+
  theme_bw()+
  theme(legend.position = "none") 

# correlation between second attempt calibration and halfway
ggplot(summary.data.calib.wide %>% filter(!is.na(`3`)), aes(x = `2`, y = `3`))+
  geom_point()+
  geom_smooth(method = 'lm')+
  theme_bw()+
  theme(legend.position = "none") 
```

```{r}

calib.by.subj = summary.data.calib %>% 
  group_by(subject_id) %>% 
  summarize(mean_percent_in_roi = mean(mean_percent_in_roi))

eyetracking.effects.by.subj = read_csv( "output/E2_eye-tracking_data_subj.csv") %>% 
 # rename("condition" = compatibility) %>% 
  filter(condition == "fixed" ) %>% 
  group_by(subject_id, normalized_quadrant) %>% 
  summarize(M = mean(proportion)) %>% 
  pivot_wider(names_from = normalized_quadrant, values_from = M) %>% 
  mutate(crit_bias = critical - (first+second+third)/3 ) %>% 
  left_join(calib.by.subj, by = "subject_id")


```

```{r E2-calib-effect, fig.cap = 'Calibration scores plotted against gaze bias (the difference between the proportion of looks to the critical quadrant minus the average proportion of looks to the average of the other three quadrants).'}
ggplot(eyetracking.effects.by.subj, aes(x = mean_percent_in_roi, y = crit_bias))+
  geom_point()+
  geom_smooth(method = "lm", formula = y ~ x) +
  labs(x="Calibration Score", y="Gaze Bias")+
  theme_bw()+
  theme(panel.grid.minor = element_blank())
```

```{r}

m_calib = broom::tidy(cor.test(eyetracking.effects.by.subj$mean_percent_in_roi, eyetracking.effects.by.subj$crit_bias))
#m_calib 
```

```{r}
m_calib_r = m_calib %>% pull(estimate ) 
m_calib_p = m_calib %>% pull(p.value ) 

```

Participants' calibration quality, measured as the mean percentage of fixations that landed within 200 pixels of the calibration point, varied substantially (between `r range(calib.by.subj$mean_percent_in_roi) %>% round(digits = 2)` %). 
The quality of a participant's calibration was not significantly correlated with the participant's effect size ( _Pearson's r_= `r m_calib_r`, _p_ = `r m_calib_p`) as measured by the difference between the proportion of looks to the critical quadrant minus the average proportion of looks to the average of the other three quadrants (see Figure\ \@ref(fig:E2-calib-effect))